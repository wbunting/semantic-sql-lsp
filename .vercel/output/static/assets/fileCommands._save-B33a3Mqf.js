import{e as v,h as se,B as oe,aI as Je,aJ as k,aK as ge,aL as Xe,y as I,D as K,aM as Qe,aN as F,b as g,aO as P,t as z,aP as y,aQ as Ze,aR as $,R as ne,aS as de,as as S,_ as p,d as u,af as et,f as H,g as L,i as tt,j as ae,k as Re,m as it,n as Oe,o as rt,aT as ve,aU as st,aV as W,aW as R,aX as ot,aY as nt,aZ as dt,a_ as at,a$ as m,b0 as T,b1 as X,b2 as ct,z as ut,b3 as j,an as J,aq as f,b4 as Me,b5 as Ge,b6 as we,A as Te,b7 as pe,b8 as Ee,aF as ht,aE as _e,b9 as _,ba as b,bb as lt,bc as Q,bd as ft,be as ce,bf as xe,K as E,bg as gt,bh as Fe,bi as ue,p as Pe,bj as Le,bk as Ue,bl as vt,aC as pt,bm as Et,bn as x,bo as St,T as Se,I as mt,bp as yt,F as Ct,bq as Dt,br as bt,bs as At,bt as It,bu as Rt,bv as Ot,ag as Mt,bw as Gt,bx as wt,by as ke,bz as Tt,bA as _t,bB as xt,bC as We,bD as Ft,bE as Pt,bF as me,bG as Y,bH as Lt,bI as Z,bJ as Ut,bK as kt,bL as Wt,bM as he,bN as Nt,bO as Vt,bP as Bt,bQ as qt,bR as Ne,l as G,bS as Ve,u as Kt,bT as zt,bU as $t,bV as ye,bW as Ht,bX as Yt}from"./monaco-editor-wrapped-CqvvOqZY.js";function Ce(c,e,t){const i=c.get(v),r=c.get(se),s=jt(e,t,i,r);return s instanceof Promise?s.then(o=>De(o,e,t,i)):De(s,e,t,i)}function De(c,e,t,i){let r;return i.activeGroup!==c&&e.options&&!e.options.inactive&&e.options.preserveFocus&&typeof e.options.activation!="number"&&t!==oe&&(r=Je.ACTIVATE),[c,r]}function jt(c,e,t,i){let r;const s=k(c)?c.editor:c,o=c.options;if(e&&typeof e!="number")r=e;else if(typeof e=="number"&&e>=0)r=t.getGroup(e);else if(e===oe){const n=ge(i);let d=t.findGroup({direction:n});(!d||U(d,s))&&(d=t.addGroup(t.activeGroup,n)),r=d}else if(e===Xe)r=t.createAuxiliaryEditorPart().then(n=>n.activeGroup);else if(!o||typeof o.index!="number"){const n=t.getGroups(1);if(o!=null&&o.revealIfVisible){for(const d of n)if(Jt(d,s)){r=d;break}}if(!r&&(o!=null&&o.revealIfOpened||i.getValue("workbench.editor.revealIfOpen")||I(s)&&s.hasCapability(8))){let d,a;for(const h of n)if(Be(h,s)&&(a||(a=h),!d&&h.isActive(s)&&(d=h)),a&&d)break;r=d||a}}if(!r){let n=t.activeGroup;if(U(n,s)){for(const d of t.getGroups(1))if(!U(d,s)){n=d;break}U(n,s)?r=t.addGroup(n,ge(i)):r=n}else r=n}return r}function U(c,e){return!(!c.isLocked||Be(c,e))}function Jt(c,e){return c.activeEditor?c.activeEditor.matches(e):!1}function Be(c,e){for(const t of c.editors)if(t.matches(e))return!0;return!1}var w,C;let ee=(C=class extends K{get count(){return this.mostRecentEditorsMap.size}get editors(){return[...this.mostRecentEditorsMap.values()]}hasEditor(e){const t=this.editorsPerResourceCounter.get(e.resource);return(t==null?void 0:t.has(this.toIdentifier(e)))??!1}hasEditors(e){return this.editorsPerResourceCounter.has(e)}toIdentifier(e,t){return typeof e!="string"?this.toIdentifier(e.typeId,e.editorId):t?`${e}/${t}`:e}constructor(e,t,i){super(),this.editorGroupService=t,this.storageService=i,this.keyMap=new Map,this.mostRecentEditorsMap=new Qe,this.editorsPerResourceCounter=new F,this._onDidMostRecentlyActiveEditorsChange=this._register(new g),this.onDidMostRecentlyActiveEditorsChange=this._onDidMostRecentlyActiveEditorsChange.event,this.editorGroupsContainer=e??t,this.isScoped=!!e,this.registerListeners(),this.loadState()}registerListeners(){this._register(this.editorGroupsContainer.onDidAddGroup(e=>this.onGroupAdded(e))),this._register(this.editorGroupService.onDidChangeEditorPartOptions(e=>this.onDidChangeEditorPartOptions(e))),this._register(this.storageService.onWillSaveState(()=>this.saveState()))}onGroupAdded(e){const t=e.getEditors(0);for(let i=t.length-1;i>=0;i--)this.addMostRecentEditor(e,t[i],!1,!0);this.editorGroupsContainer.activeGroup===e&&e.activeEditor&&this.addMostRecentEditor(e,e.activeEditor,!0,!1),this.registerGroupListeners(e)}registerGroupListeners(e){const t=new P;t.add(e.onDidModelChange(i=>{switch(i.kind){case 0:{this.editorGroupsContainer.activeGroup===e&&e.activeEditor&&this.addMostRecentEditor(e,e.activeEditor,!0,!1);break}case 5:{i.editor&&(this.addMostRecentEditor(e,i.editor,!1,!0),this.ensureOpenedEditorsLimit({groupId:e.id,editor:i.editor},e.id));break}}})),t.add(e.onDidCloseEditor(i=>{this.removeMostRecentEditor(e,i.editor)})),t.add(e.onDidActiveEditorChange(i=>{i.editor&&this.addMostRecentEditor(e,i.editor,this.editorGroupsContainer.activeGroup===e,!1)})),z.once(e.onWillDispose)(()=>y(t))}onDidChangeEditorPartOptions(e){if(!Ze(e.newPartOptions.limit,e.oldPartOptions.limit)){const t=this.editorGroupsContainer.activeGroup;let i;t.activeEditor&&(i={editor:t.activeEditor,groupId:t.id}),this.ensureOpenedEditorsLimit(i)}}addMostRecentEditor(e,t,i,r){const s=this.ensureKey(e,t),o=this.mostRecentEditorsMap.first;i||!o?this.mostRecentEditorsMap.set(s,s,o?1:void 0):(this.mostRecentEditorsMap.set(s,s,1),this.mostRecentEditorsMap.set(o,o,1)),r&&this.updateEditorResourcesMap(t,!0),this._onDidMostRecentlyActiveEditorsChange.fire()}updateEditorResourcesMap(e,t){let i,r,s;if(e instanceof $?(i=e.primary.resource,r=e.primary.typeId,s=e.primary.editorId):(i=e.resource,r=e.typeId,s=e.editorId),!i)return;const o=this.toIdentifier(r,s);if(t){let n=this.editorsPerResourceCounter.get(i);n||(n=new Map,this.editorsPerResourceCounter.set(i,n)),n.set(o,(n.get(o)??0)+1)}else{const n=this.editorsPerResourceCounter.get(i);if(n){const d=n.get(o)??0;d>1?n.set(o,d-1):(n.delete(o),n.size===0&&this.editorsPerResourceCounter.delete(i))}}}removeMostRecentEditor(e,t){this.updateEditorResourcesMap(t,!1);const i=this.findKey(e,t);if(i){this.mostRecentEditorsMap.delete(i);const r=this.keyMap.get(e.id);r&&r.delete(i.editor)&&r.size===0&&this.keyMap.delete(e.id),this._onDidMostRecentlyActiveEditorsChange.fire()}}findKey(e,t){const i=this.keyMap.get(e.id);if(i)return i.get(t)}ensureKey(e,t){let i=this.keyMap.get(e.id);i||(i=new Map,this.keyMap.set(e.id,i));let r=i.get(t);return r||(r={groupId:e.id,editor:t},i.set(t,r)),r}async ensureOpenedEditorsLimit(e,t){var r,s;if(!((r=this.editorGroupService.partOptions.limit)!=null&&r.enabled)||typeof this.editorGroupService.partOptions.limit.value!="number"||this.editorGroupService.partOptions.limit.value<=0)return;const i=this.editorGroupService.partOptions.limit.value;if((s=this.editorGroupService.partOptions.limit)!=null&&s.perEditorGroup)if(typeof t=="number"){const o=this.editorGroupsContainer.getGroup(t);o&&await this.doEnsureOpenedEditorsLimit(i,o.getEditors(0).map(n=>({editor:n,groupId:t})),e)}else for(const o of this.editorGroupsContainer.groups)await this.ensureOpenedEditorsLimit(e,o.id);else await this.doEnsureOpenedEditorsLimit(i,[...this.mostRecentEditorsMap.values()],e)}async doEnsureOpenedEditorsLimit(e,t,i){var d;let r;if((d=this.editorGroupService.partOptions.limit)!=null&&d.excludeDirty?r=t.filter(({editor:a})=>!(a.isDirty()&&!a.isSaving()||a.hasCapability(512))):r=t,e>=r.length)return;const s=r.reverse().filter(({editor:a,groupId:h})=>{var l;return!(a.isDirty()&&!a.isSaving()||a.hasCapability(512)||i&&a===i.editor&&h===i.groupId||(l=this.editorGroupsContainer.getGroup(h))!=null&&l.isSticky(a))});let o=r.length-e;const n=new Map;for(const{groupId:a,editor:h}of s){let l=n.get(a);if(l||(l=[],n.set(a,l)),l.push(h),o--,o===0)break}for(const[a,h]of n){const l=this.editorGroupsContainer.getGroup(a);l&&await l.closeEditors(h,{preserveFocus:!0})}}saveState(){this.isScoped||(this.mostRecentEditorsMap.isEmpty()?this.storageService.remove(w.STORAGE_KEY,1):this.storageService.store(w.STORAGE_KEY,JSON.stringify(this.serialize()),1,1))}serialize(){const e=ne.as(de.EditorFactory),t=[...this.mostRecentEditorsMap.values()],i=new Map;return{entries:S(t.map(({editor:r,groupId:s})=>{const o=this.editorGroupsContainer.getGroup(s);if(!o)return;let n=i.get(o);n||(n=o.getEditors(1).filter(a=>{const h=e.getEditorSerializer(a);return h==null?void 0:h.canSerialize(a)}),i.set(o,n));const d=n.indexOf(r);if(d!==-1)return{groupId:s,index:d}}))}}async loadState(){(this.editorGroupsContainer===this.editorGroupService.mainPart||this.editorGroupsContainer===this.editorGroupService)&&await this.editorGroupService.whenReady;let e=!1;if(!this.isScoped){const t=this.storageService.get(w.STORAGE_KEY,1);t&&(e=!0,this.deserialize(JSON.parse(t)))}if(!e){const t=this.editorGroupsContainer.getGroups(1);for(let i=t.length-1;i>=0;i--){const r=t[i],s=r.getEditors(0);for(let o=s.length-1;o>=0;o--)this.addMostRecentEditor(r,s[o],!0,!0)}}for(const t of this.editorGroupsContainer.groups)this.registerGroupListeners(t)}deserialize(e){const t=[];for(const{groupId:i,index:r}of e.entries){const s=this.editorGroupsContainer.getGroup(i);if(!s)continue;const o=s.getEditorByIndex(r);if(!o)continue;const n=this.ensureKey(s,o);t.push([n,n]),this.updateEditorResourcesMap(o,!0)}this.mostRecentEditorsMap.fromJSON(t)}},w=C,C.STORAGE_KEY="editors.mru",C);ee=w=p([u(1,v),u(2,et)],ee);var te;let be=te=class extends K{constructor(e,t,i,r,s,o,n,d,a,h,l){super(),this.editorGroupService=t,this.instantiationService=i,this.fileService=r,this.configurationService=s,this.contextService=o,this.uriIdentityService=n,this.editorResolverService=d,this.workspaceTrustRequestService=a,this.hostService=h,this.textEditorService=l,this._onDidActiveEditorChange=this._register(new g),this.onDidActiveEditorChange=this._onDidActiveEditorChange.event,this._onDidVisibleEditorsChange=this._register(new g),this.onDidVisibleEditorsChange=this._onDidVisibleEditorsChange.event,this._onDidEditorsChange=this._register(new g),this.onDidEditorsChange=this._onDidEditorsChange.event,this._onWillOpenEditor=this._register(new g),this.onWillOpenEditor=this._onWillOpenEditor.event,this._onDidCloseEditor=this._register(new g),this.onDidCloseEditor=this._onDidCloseEditor.event,this._onDidOpenEditorFail=this._register(new g),this.onDidOpenEditorFail=this._onDidOpenEditorFail.event,this._onDidMostRecentlyActiveEditorsChange=this._register(new g),this.onDidMostRecentlyActiveEditorsChange=this._onDidMostRecentlyActiveEditorsChange.event,this.lastActiveEditor=void 0,this.activeOutOfWorkspaceWatchers=new F,this.closeOnFileDelete=!1,this.editorGroupsContainer=e??t,this.editorsObserver=this._register(this.instantiationService.createInstance(ee,this.editorGroupsContainer)),this.onConfigurationUpdated(),this.registerListeners()}createScoped(e,t){return t.add(new te(e==="main"?this.editorGroupService.mainPart:e,this.editorGroupService,this.instantiationService,this.fileService,this.configurationService,this.contextService,this.uriIdentityService,this.editorResolverService,this.workspaceTrustRequestService,this.hostService,this.textEditorService))}registerListeners(){this.editorGroupsContainer===this.editorGroupService.mainPart||this.editorGroupsContainer===this.editorGroupService?this.editorGroupService.whenReady.then(()=>this.onEditorGroupsReady()):this.onEditorGroupsReady(),this._register(this.editorGroupsContainer.onDidChangeActiveGroup(e=>this.handleActiveEditorChange(e))),this._register(this.editorGroupsContainer.onDidAddGroup(e=>this.registerGroupListeners(e))),this._register(this.editorsObserver.onDidMostRecentlyActiveEditorsChange(()=>this._onDidMostRecentlyActiveEditorsChange.fire())),this._register(this.onDidVisibleEditorsChange(()=>this.handleVisibleEditorsChange())),this._register(this.fileService.onDidRunOperation(e=>this.onDidRunFileOperation(e))),this._register(this.fileService.onDidFilesChange(e=>this.onDidFilesChange(e))),this._register(this.configurationService.onDidChangeConfiguration(e=>this.onConfigurationUpdated(e)))}onEditorGroupsReady(){for(const e of this.editorGroupsContainer.groups)this.registerGroupListeners(e);this.activeEditor&&(this.doHandleActiveEditorChangeEvent(),this._onDidVisibleEditorsChange.fire())}handleActiveEditorChange(e){e===this.editorGroupsContainer.activeGroup&&(!this.lastActiveEditor&&!e.activeEditor||this.doHandleActiveEditorChangeEvent())}doHandleActiveEditorChangeEvent(){const e=this.editorGroupsContainer.activeGroup;this.lastActiveEditor=e.activeEditor??void 0,this._onDidActiveEditorChange.fire()}registerGroupListeners(e){const t=new P;t.add(e.onDidModelChange(i=>{this._onDidEditorsChange.fire({groupId:e.id,event:i})})),t.add(e.onDidActiveEditorChange(()=>{this.handleActiveEditorChange(e),this._onDidVisibleEditorsChange.fire()})),t.add(e.onWillOpenEditor(i=>{this._onWillOpenEditor.fire(i)})),t.add(e.onDidCloseEditor(i=>{this._onDidCloseEditor.fire(i)})),t.add(e.onDidOpenEditorFail(i=>{this._onDidOpenEditorFail.fire({editor:i,groupId:e.id})})),z.once(e.onWillDispose)(()=>{y(t)})}handleVisibleEditorsChange(){const e=new ve;for(const t of this.visibleEditors){const i=st(S([W.getCanonicalUri(t,{supportSideBySide:R.PRIMARY}),W.getCanonicalUri(t,{supportSideBySide:R.SECONDARY})]),r=>r.toString());for(const r of i)this.fileService.hasProvider(r)&&!this.contextService.isInsideWorkspace(r)&&e.add(r)}for(const t of this.activeOutOfWorkspaceWatchers.keys())e.has(t)||(y(this.activeOutOfWorkspaceWatchers.get(t)),this.activeOutOfWorkspaceWatchers.delete(t));for(const t of e.keys())if(!this.activeOutOfWorkspaceWatchers.get(t)){const i=this.fileService.watch(t);this.activeOutOfWorkspaceWatchers.set(t,i)}}async onDidRunFileOperation(e){e.isOperation(2)&&this.handleMovedFile(e.resource,e.target.resource),(e.isOperation(1)||e.isOperation(2))&&this.handleDeletedFile(e.resource,!1,e.target?e.target.resource:void 0)}onDidFilesChange(e){e.gotDeleted()&&this.handleDeletedFile(e,!0)}async handleMovedFile(e,t){for(const i of this.editorGroupsContainer.groups){const r=[];for(const s of i.editors){const o=s.resource;if(!o||!this.uriIdentityService.extUri.isEqualOrParent(o,e))continue;let n;if(this.uriIdentityService.extUri.isEqual(e,o))n=t;else{const h=ot(o.path,e.path,this.uriIdentityService.extUri.ignorePathCasing(o));n=nt(t,o.path.substr(h+e.path.length+1))}const d=await s.rename(i.id,n);if(!d)return;const a={preserveFocus:!0,pinned:i.isPinned(s),sticky:i.isSticky(s),index:i.getIndexOfEditor(s),inactive:!i.isActive(s)};I(d.editor)?r.push({editor:s,replacement:d.editor,options:{...d.options,...a}}):r.push({editor:s,replacement:{...d.editor,options:{...d.editor.options,...a}}})}r.length&&this.replaceEditors(r,i)}}onConfigurationUpdated(e){var i,r;if(e&&!e.affectsConfiguration("workbench.editor.closeOnFileDelete"))return;const t=this.configurationService.getValue();typeof((r=(i=t.workbench)==null?void 0:i.editor)==null?void 0:r.closeOnFileDelete)=="boolean"?this.closeOnFileDelete=t.workbench.editor.closeOnFileDelete:this.closeOnFileDelete=!1}handleDeletedFile(e,t,i){for(const r of this.getAllNonDirtyEditors({includeUntitled:!1,supportSideBySide:!0}))(async()=>{const s=r.resource;if(s&&(this.closeOnFileDelete||!t)){if(i&&this.uriIdentityService.extUri.isEqualOrParent(s,i))return;let o=!1;if(e instanceof dt?o=e.contains(s,2):o=this.uriIdentityService.extUri.isEqualOrParent(s,e),!o)return;let n=!1;t&&this.fileService.hasProvider(s)&&(await at(100),n=await this.fileService.exists(s)),!n&&!r.isDisposed()&&r.dispose()}})()}getAllNonDirtyEditors(e){const t=[];function i(r){r.hasCapability(4)&&!e.includeUntitled||r.isDirty()||t.push(r)}for(const r of this.editors)e.supportSideBySide&&r instanceof $?(i(r.primary),i(r.secondary)):i(r);return t}get activeEditorPane(){var e;return(e=this.editorGroupsContainer.activeGroup)==null?void 0:e.activeEditorPane}get activeTextEditorControl(){const e=this.activeEditorPane;if(e){const t=e.getControl();if(m(t)||T(t))return t;if(X(t)&&m(t.activeCodeEditor))return t.activeCodeEditor}}get activeTextEditorLanguageId(){var i;let e;const t=this.activeTextEditorControl;return T(t)?e=t.getModifiedEditor():e=t,(i=e==null?void 0:e.getModel())==null?void 0:i.getLanguageId()}get count(){return this.editorsObserver.count}get editors(){return this.getEditors(1).map(({editor:e})=>e)}getEditors(e,t){switch(e){case 0:return t!=null&&t.excludeSticky?this.editorsObserver.editors.filter(({groupId:i,editor:r})=>{var s;return!((s=this.editorGroupsContainer.getGroup(i))!=null&&s.isSticky(r))}):this.editorsObserver.editors;case 1:{const i=[];for(const r of this.editorGroupsContainer.getGroups(2))i.push(...r.getEditors(1,t).map(s=>({editor:s,groupId:r.id})));return i}}}get activeEditor(){const e=this.editorGroupsContainer.activeGroup;return e?e.activeEditor??void 0:void 0}get visibleEditorPanes(){return S(this.editorGroupsContainer.groups.map(e=>e.activeEditorPane))}get visibleTextEditorControls(){var t,i;const e=[];for(const r of this.visibleEditorPanes){const s=[];r instanceof ct?(s.push((t=r.getPrimaryEditorPane())==null?void 0:t.getControl()),s.push((i=r.getSecondaryEditorPane())==null?void 0:i.getControl())):s.push(r.getControl());for(const o of s)(m(o)||T(o))&&e.push(o)}return e}get visibleEditors(){return S(this.editorGroupsContainer.groups.map(e=>e.activeEditor))}async openEditor(e,t,i){let r,s=I(e)?t:e.options,o;if(ut(t)&&(i=t),!I(e)){const n=await this.editorResolverService.resolveEditor(e,i);if(n===1)return;j(n)&&(r=n.editor,s=n.options,o=n.group)}if(r||(r=I(e)?e:await this.textEditorService.resolveTextEditor(e)),!o){let n;const d=this.instantiationService.invokeFunction(Ce,{editor:r,options:s},i);d instanceof Promise?[o,n]=await d:[o,n]=d,n&&(s={...s,activation:n})}return o.openEditor(r,s)}async openEditors(e,t,i){if(i!=null&&i.validateTrust&&!await this.handleWorkspaceTrust(e))return[];const r=new Map;for(const o of e){let n,d;if(!k(o)){const h=await this.editorResolverService.resolveEditor(o,t);if(h===1)continue;j(h)&&(n=h,d=h.group)}if(n||(n=k(o)?o:{editor:await this.textEditorService.resolveTextEditor(o),options:o.options}),!d){const h=this.instantiationService.invokeFunction(Ce,n,t);h instanceof Promise?[d]=await h:[d]=h}let a=r.get(d);a||(a=[],r.set(d,a)),a.push(n)}const s=[];for(const[o,n]of r)s.push(o.openEditors(n));return S(await J.settled(s))}async handleWorkspaceTrust(e){const{resources:t,diffMode:i,mergeMode:r}=this.extractEditorResources(e);switch(await this.workspaceTrustRequestService.requestOpenFilesTrust(t)){case 1:return!0;case 2:return await this.hostService.openWindow(t.map(o=>({fileUri:o})),{forceNewWindow:!0,diffMode:i,mergeMode:r}),!1;case 3:return!1}}extractEditorResources(e){const t=new ve;let i=!1,r=!1;for(const s of e)if(k(s)){const o=W.getOriginalUri(s.editor,{supportSideBySide:R.BOTH});f.isUri(o)?t.add(o):o&&(o.primary&&t.add(o.primary),o.secondary&&t.add(o.secondary),i=s.editor instanceof Me)}else Ge(s)&&(f.isUri(s.input1)&&t.add(s.input1.resource),f.isUri(s.input2)&&t.add(s.input2.resource),f.isUri(s.base)&&t.add(s.base.resource),f.isUri(s.result)&&t.add(s.result.resource),r=!0),we(s)?(f.isUri(s.original.resource)&&t.add(s.original.resource),f.isUri(s.modified.resource)&&t.add(s.modified.resource),i=!0):Te(s)&&t.add(s.resource);return{resources:Array.from(t.keys()),diffMode:i,mergeMode:r}}isOpened(e){return this.editorsObserver.hasEditor({resource:this.uriIdentityService.asCanonicalUri(e.resource),typeId:e.typeId,editorId:e.editorId})}isVisible(e){var t;for(const i of this.editorGroupsContainer.groups)if((t=i.activeEditor)!=null&&t.matches(e))return!0;return!1}async closeEditor({editor:e,groupId:t},i){const r=this.editorGroupsContainer.getGroup(t);await(r==null?void 0:r.closeEditor(e,i))}async closeEditors(e,t){const i=new Map;for(const{editor:r,groupId:s}of e){const o=this.editorGroupsContainer.getGroup(s);if(!o)continue;let n=i.get(o);n||(n=[],i.set(o,n)),n.push(r)}for(const[r,s]of i)await r.closeEditors(s,t)}findEditors(e,t,i){const r=f.isUri(e)?e:e.resource,s=f.isUri(e)?void 0:e.typeId;if((t==null?void 0:t.supportSideBySide)!==R.ANY&&(t==null?void 0:t.supportSideBySide)!==R.SECONDARY&&!this.editorsObserver.hasEditors(r))return f.isUri(e)||pe(i)?[]:void 0;if(pe(i)){const o=[];for(const n of this.editorGroupsContainer.getGroups(1)){const d=[];if(f.isUri(e))d.push(...this.findEditors(e,t,n));else{const a=this.findEditors(e,t,n);a&&d.push(a)}o.push(...d.map(a=>({editor:a,groupId:n.id})))}return o}else{const o=typeof i=="number"?this.editorGroupsContainer.getGroup(i):i;if(f.isUri(e))return o?o.findEditors(r,t):[];{if(!o)return;const n=o.findEditors(r,t);for(const d of n)if(d.typeId===s)return d;return}}}async replaceEditors(e,t){const i=typeof t=="number"?this.editorGroupsContainer.getGroup(t):t,r=[];for(const s of e){let o;if(!I(s.replacement)){const n=await this.editorResolverService.resolveEditor(s.replacement,i);if(n===1)continue;j(n)&&(o={editor:s.editor,replacement:n.editor,options:n.options,forceReplaceDirty:s.forceReplaceDirty})}o||(o={editor:s.editor,replacement:Ee(s)?s.replacement:await this.textEditorService.resolveTextEditor(s.replacement),options:Ee(s)?s.options:s.replacement.options,forceReplaceDirty:s.forceReplaceDirty}),r.push(o)}return i==null?void 0:i.replaceEditors(r)}async save(e,t){Array.isArray(e)||(e=[e]);const i=this.getUniqueEditors(e),r=[],s=[];if(t!=null&&t.saveAs)s.push(...i);else for(const{groupId:n,editor:d}of i)d.hasCapability(4)?s.push({groupId:n,editor:d}):r.push({groupId:n,editor:d});const o=await J.settled(r.map(({groupId:n,editor:d})=>{var a;return(t==null?void 0:t.reason)===1&&((a=this.editorGroupsContainer.getGroup(n))==null||a.pinEditor(d)),d.save(n,t)}));for(const{groupId:n,editor:d}of s){if(d.isDisposed())continue;const a=await this.openEditor(d,n),h={pinned:!0,viewState:a==null?void 0:a.getViewState()},l=t!=null&&t.saveAs?await d.saveAs(n,t):await d.save(n,t);if(o.push(l),!l)break;if(!d.matches(l)){const M=d.hasCapability(4)?this.editorGroupsContainer.groups.map(A=>A.id):[n];for(const A of M)l instanceof ht?await this.replaceEditors([{editor:d,replacement:l,options:h}],A):await this.replaceEditors([{editor:d,replacement:{...l,options:h}}],A)}}return{success:o.every(n=>!!n),editors:S(o)}}saveAll(e){return this.save(this.getAllModifiedEditors(e),e)}async revert(e,t){Array.isArray(e)||(e=[e]);const i=this.getUniqueEditors(e);return await J.settled(i.map(async({groupId:r,editor:s})=>{var o;return(o=this.editorGroupsContainer.getGroup(r))==null||o.pinEditor(s),s.revert(r,t)})),!i.some(({editor:r})=>r.isDirty())}async revertAll(e){return this.revert(this.getAllModifiedEditors(e),e)}getAllModifiedEditors(e){var i;const t=[];for(const r of this.editorGroupsContainer.getGroups(1))for(const s of r.getEditors(0))s.isModified()&&((typeof(e==null?void 0:e.includeUntitled)=="boolean"||!((i=e==null?void 0:e.includeUntitled)!=null&&i.includeScratchpad))&&s.hasCapability(512)||!(e!=null&&e.includeUntitled)&&s.hasCapability(4)||e!=null&&e.excludeSticky&&r.isSticky(s)||t.push({groupId:r.id,editor:s}));return t}getUniqueEditors(e){const t=[];for(const{editor:i,groupId:r}of e)t.some(s=>s.editor.matches(i))||t.push({editor:i,groupId:r});return t}dispose(){super.dispose(),this.activeOutOfWorkspaceWatchers.forEach(e=>y(e)),this.activeOutOfWorkspaceWatchers.clear()}};be=te=p([u(1,v),u(2,H),u(3,L),u(4,se),u(5,tt),u(6,ae),u(7,Re),u(8,it),u(9,Oe),u(10,rt)],be);var N,D;let V=(D=class extends _e{get typeId(){return N.ID}get editorId(){return _.id}constructor(e,t,i,r,s,o,n,d,a,h,l){super(e.resource,void 0,r,t,i,s,d,h,l),this.model=e,this.environmentService=o,this.pathService=n,this.textModelService=a,this.modelResolve=void 0,this.modelDisposables=this._register(new P),this.cachedUntitledTextEditorModelReference=void 0,this.registerModelListeners(e),this._register(this.textFileService.untitled.onDidCreate(M=>this.onDidCreateUntitledModel(M)))}registerModelListeners(e){this.modelDisposables.clear(),this.modelDisposables.add(e.onDidChangeDirty(()=>this._onDidChangeDirty.fire())),this.modelDisposables.add(e.onDidChangeName(()=>this._onDidChangeLabel.fire())),this.modelDisposables.add(e.onDidRevert(()=>this.dispose()))}onDidCreateUntitledModel(e){b(e.resource,this.model.resource)&&e!==this.model&&(this.model=e,this.registerModelListeners(e))}getName(){return this.model.name}getDescription(e=1){if(!this.model.hasAssociatedFilePath){const t=this.resource.path;return t!==this.getName()?t:void 0}return super.getDescription(e)}getTitle(e){if(!this.model.hasAssociatedFilePath){const t=this.getName(),i=this.getDescription();return i&&i!==t?`${t} • ${i}`:t}return super.getTitle(e)}isDirty(){return this.model.isDirty()}getEncoding(){return this.model.getEncoding()}setEncoding(e,t){return this.model.setEncoding(e)}get hasLanguageSetExplicitly(){return this.model.hasLanguageSetExplicitly}get hasAssociatedFilePath(){return this.model.hasAssociatedFilePath}setLanguageId(e,t){this.model.setLanguageId(e,t)}getLanguageId(){return this.model.getLanguageId()}async resolve(){return this.modelResolve||(this.modelResolve=(async()=>{this.cachedUntitledTextEditorModelReference=await this.textModelService.createModelReference(this.resource)})()),await this.modelResolve,this.isDisposed()&&this.disposeModelReference(),this.model}toUntyped(e){var i;const t={resource:this.model.hasAssociatedFilePath?lt(this.model.resource,this.environmentService.remoteAuthority,this.pathService.defaultUriScheme):this.resource,forceUntitled:!0,options:{override:this.editorId}};return typeof(e==null?void 0:e.preserveViewState)=="number"&&(t.encoding=this.getEncoding(),t.languageId=this.getLanguageId(),t.contents=this.model.isModified()?(i=this.model.textEditorModel)==null?void 0:i.getValue():void 0,t.options.viewState=Q(this,e.preserveViewState,this.editorService),typeof t.contents=="string"&&!this.model.hasAssociatedFilePath&&!e.preserveResource&&(t.resource=void 0)),t}matches(e){return this===e?!0:e instanceof N?b(e.resource,this.resource):ft(e)?super.matches(e):!1}dispose(){this.modelResolve=void 0,this.disposeModelReference(),super.dispose()}disposeModelReference(){y(this.cachedUntitledTextEditorModelReference),this.cachedUntitledTextEditorModelReference=void 0}},N=D,D.ID="workbench.editors.untitledEditorInput",D);V=N=p([u(1,ce),u(2,xe),u(3,E),u(4,L),u(5,gt),u(6,Fe),u(7,ue),u(8,Pe),u(9,Le),u(10,Ue)],V);let Ae=class extends K{constructor(e,t,i,r,s){super(),this.untitledTextEditorService=e,this.instantiationService=t,this.uriIdentityService=i,this.fileService=r,this.editorResolverService=s,this.editorInputCache=new F,this.fileEditorFactory=ne.as(de.EditorFactory).getFileEditorFactory(),this.registerDefaultEditor()}registerDefaultEditor(){this._register(this.editorResolverService.registerEditor("*",{id:_.id,label:_.displayName,detail:_.providerDisplayName,priority:pt.builtin},{},{createEditorInput:e=>({editor:this.createTextEditor(e)}),createUntitledEditorInput:e=>({editor:this.createTextEditor(e)}),createDiffEditorInput:e=>({editor:this.createTextEditor(e)})}))}async resolveTextEditor(e){return this.createTextEditor(e)}createTextEditor(e){var r;if(Ge(e))return this.createTextEditor(e.result);if(we(e)){const s=this.createTextEditor(e.original),o=this.createTextEditor(e.modified);return this.instantiationService.createInstance(Me,e.label,e.description,s,o,void 0)}if(Et(e)){const s=this.createTextEditor(e.primary),o=this.createTextEditor(e.secondary);return this.instantiationService.createInstance($,e.label,e.description,o,s)}const t=e;if(t.forceUntitled||!t.resource||t.resource.scheme===x.untitled){const s={languageId:t.languageId,initialValue:t.contents,encoding:t.encoding};let o;return((r=t.resource)==null?void 0:r.scheme)===x.untitled?o=this.untitledTextEditorService.create({untitledResource:t.resource,...s}):o=this.untitledTextEditorService.create({associatedResource:t.resource,...s}),this.createOrGetCached(o.resource,()=>this.instantiationService.createInstance(V,o))}const i=e;if(i.resource instanceof f){const s=i.label||St(i.resource),o=i.resource,n=this.uriIdentityService.asCanonicalUri(o);return this.createOrGetCached(n,()=>i.forceFile||this.fileService.hasProvider(n)?this.fileEditorFactory.createFileEditor(n,o,i.label,i.description,i.encoding,i.languageId,i.contents,this.instantiationService):this.instantiationService.createInstance(Se,n,i.label,i.description,i.languageId,i.contents),d=>{d instanceof V||(d instanceof Se?(s&&d.setName(s),i.description&&d.setDescription(i.description),i.languageId&&d.setPreferredLanguageId(i.languageId),typeof i.contents=="string"&&d.setPreferredContents(i.contents)):(d.setPreferredResource(o),i.label&&d.setPreferredName(i.label),i.description&&d.setPreferredDescription(i.description),i.encoding&&d.setPreferredEncoding(i.encoding),i.languageId&&d.setPreferredLanguageId(i.languageId),typeof i.contents=="string"&&d.setPreferredContents(i.contents)))})}throw new Error(`ITextEditorService: Unable to create texteditor from ${JSON.stringify(e)}`)}createOrGetCached(e,t,i){let r=this.editorInputCache.get(e);return r?(i==null||i(r),r):(r=t(),this.editorInputCache.set(e,r),z.once(r.onWillDispose)(()=>this.editorInputCache.delete(e)),r)}};Ae=p([u(0,vt),u(1,H),u(2,ae),u(3,L),u(4,Re)],Ae);let Ie=class extends yt{constructor(e,t,i){super(t),this.editorService=e,this.configurationService=i,this._register(this.registerCodeEditorOpenHandler(this.doOpenCodeEditor.bind(this))),this._register(this.registerCodeEditorOpenHandler(this.doOpenCodeEditorFromDiff.bind(this)))}getActiveCodeEditor(){var i;const e=this.editorService.activeTextEditorControl;if(m(e))return e;if(T(e))return e.getModifiedEditor();const t=(i=this.editorService.activeEditorPane)==null?void 0:i.getControl();return X(t)&&m(t.activeCodeEditor)?t.activeCodeEditor:null}async doOpenCodeEditorFromDiff(e,t,i){var s;const r=this.editorService.activeTextEditorControl;if(!i&&T(r)&&e.options&&e.resource&&t===r.getModifiedEditor()&&r.getModel()&&b(e.resource,(s=r.getModel())==null?void 0:s.modified.uri)){const o=r.getModifiedEditor();return Ct(e.options,o,0),o}return null}async doOpenCodeEditor(e,t,i){var o,n,d,a;if(!((n=(o=this.configurationService.getValue().workbench)==null?void 0:o.editor)==null?void 0:n.enablePreviewFromCodeNavigation)&&t&&!((d=e.options)!=null&&d.pinned)&&!i&&!b((a=t.getModel())==null?void 0:a.uri,e.resource)){for(const h of this.editorService.visibleEditorPanes)if(Dt(h.getControl())===t){h.group.pinEditor();break}}const s=await this.editorService.openEditor(e,i?oe:bt);if(s){const h=s.getControl();if(m(h))return h;if(X(h)&&m(h.activeCodeEditor))return h.activeCodeEditor}return null}};Ie=p([u(0,E),u(1,mt),u(2,se)],Ie);let ie=class extends At{constructor(e,t,i){super(),this.resource=e,this.name=t,this.fileService=i,this.mime=It.binary}getName(){return this.name}getSize(){return this.size}getMime(){return this.mime}getETag(){return this.etag}async resolve(){if(this.fileService.hasProvider(this.resource)){const e=await this.fileService.stat(this.resource);this.etag=e.etag,typeof e.size=="number"&&(this.size=e.size)}return super.resolve()}};ie=p([u(2,L)],ie);var O;let B=(O=class extends K{constructor(e,t,i,r,s,o,n,d){super(),this.filesConfigurationService=e,this.hostService=t,this.editorService=i,this.editorGroupService=r,this.workingCopyService=s,this.logService=o,this.markerService=n,this.uriIdentityService=d,this.scheduledAutoSavesAfterDelay=new Map,this.lastActiveEditor=void 0,this.lastActiveGroupId=void 0,this.lastActiveEditorControlDisposable=this._register(new P),this.waitingOnConditionAutoSaveWorkingCopies=new F(a=>this.uriIdentityService.extUri.getComparisonKey(a)),this.waitingOnConditionAutoSaveEditors=new F(a=>this.uriIdentityService.extUri.getComparisonKey(a));for(const a of this.workingCopyService.dirtyWorkingCopies)this.onDidRegister(a);this.registerListeners()}registerListeners(){this._register(this.hostService.onDidChangeFocus(e=>this.onWindowFocusChange(e))),this._register(this.hostService.onDidChangeActiveWindow(()=>this.onActiveWindowChange())),this._register(this.editorService.onDidActiveEditorChange(()=>this.onDidActiveEditorChange())),this._register(this.filesConfigurationService.onDidChangeAutoSaveConfiguration(()=>this.onDidChangeAutoSaveConfiguration())),this._register(this.workingCopyService.onDidRegister(e=>this.onDidRegister(e))),this._register(this.workingCopyService.onDidUnregister(e=>this.onDidUnregister(e))),this._register(this.workingCopyService.onDidChangeDirty(e=>this.onDidChangeDirty(e))),this._register(this.workingCopyService.onDidChangeContent(e=>this.onDidChangeContent(e))),this._register(this.markerService.onMarkerChanged(e=>this.onConditionChanged(e,3))),this._register(this.filesConfigurationService.onDidChangeAutoSaveDisabled(e=>this.onConditionChanged([e],4)))}onConditionChanged(e,t){for(const i of e){const r=this.waitingOnConditionAutoSaveWorkingCopies.get(i);if((r==null?void 0:r.condition)===t)r.workingCopy.isDirty()&&this.filesConfigurationService.getAutoSaveMode(r.workingCopy.resource,r.reason).mode!==0&&(this.discardAutoSave(r.workingCopy),this.logService.trace("[editor auto save] running auto save from condition change event",r.workingCopy.resource.toString(),r.workingCopy.typeId),r.workingCopy.save({reason:r.reason}));else{const s=this.waitingOnConditionAutoSaveEditors.get(i);(s==null?void 0:s.condition)===t&&!s.editor.editor.isDisposed()&&s.editor.editor.isDirty()&&this.filesConfigurationService.getAutoSaveMode(s.editor.editor,s.reason).mode!==0&&(this.waitingOnConditionAutoSaveEditors.delete(i),this.logService.trace(`[editor auto save] running auto save from condition change event with reason ${s.reason}`),this.editorService.save(s.editor,{reason:s.reason}))}}}onWindowFocusChange(e){e||this.maybeTriggerAutoSave(4)}onActiveWindowChange(){this.maybeTriggerAutoSave(4)}onDidActiveEditorChange(){this.lastActiveEditor&&typeof this.lastActiveGroupId=="number"&&this.maybeTriggerAutoSave(3,{groupId:this.lastActiveGroupId,editor:this.lastActiveEditor});const e=this.editorGroupService.activeGroup,t=this.lastActiveEditor=e.activeEditor??void 0;this.lastActiveGroupId=e.id,this.lastActiveEditorControlDisposable.clear();const i=this.editorService.activeEditorPane;t&&i&&this.lastActiveEditorControlDisposable.add(i.onDidBlur(()=>{this.maybeTriggerAutoSave(3,{groupId:e.id,editor:t})}))}maybeTriggerAutoSave(e,t){if(t){if(!t.editor.isDirty()||t.editor.isReadonly()||t.editor.hasCapability(4))return;const i=this.filesConfigurationService.getAutoSaveMode(t.editor,e);i.mode!==0?(e===4&&(i.mode===3||i.mode===4)||e===3&&i.mode===3)&&(this.logService.trace(`[editor auto save] triggering auto save with reason ${e}`),this.editorService.save(t,{reason:e})):t.editor.resource&&(i.reason===3||i.reason===4)&&this.waitingOnConditionAutoSaveEditors.set(t.editor.resource,{editor:t,reason:e,condition:i.reason})}else this.saveAllDirtyAutoSaveables(e)}onDidChangeAutoSaveConfiguration(){let e;switch(this.filesConfigurationService.getAutoSaveMode(void 0).mode){case 3:e=3;break;case 4:e=4;break;case 1:case 2:e=2;break}e&&this.saveAllDirtyAutoSaveables(e)}saveAllDirtyAutoSaveables(e){for(const t of this.workingCopyService.dirtyWorkingCopies){if(t.capabilities&2)continue;const i=this.filesConfigurationService.getAutoSaveMode(t.resource,e);i.mode!==0?t.save({reason:e}):(i.reason===3||i.reason===4)&&this.waitingOnConditionAutoSaveWorkingCopies.set(t.resource,{workingCopy:t,reason:e,condition:i.reason})}}onDidRegister(e){e.isDirty()&&this.scheduleAutoSave(e)}onDidUnregister(e){this.discardAutoSave(e)}onDidChangeDirty(e){e.isDirty()?this.scheduleAutoSave(e):this.discardAutoSave(e)}onDidChangeContent(e){e.isDirty()&&this.scheduleAutoSave(e)}scheduleAutoSave(e){if(e.capabilities&2)return;const t=this.filesConfigurationService.getAutoSaveConfiguration(e.resource).autoSaveDelay;if(typeof t!="number")return;this.discardAutoSave(e),this.logService.trace(`[editor auto save] scheduling auto save after ${t}ms`,e.resource.toString(),e.typeId);const i=setTimeout(()=>{if(this.discardAutoSave(e),e.isDirty()){const s=this.filesConfigurationService.getAutoSaveMode(e.resource,2);s.mode!==0?(this.logService.trace("[editor auto save] running auto save",e.resource.toString(),e.typeId),e.save({reason:2})):(s.reason===3||s.reason===4)&&this.waitingOnConditionAutoSaveWorkingCopies.set(e.resource,{workingCopy:e,reason:2,condition:s.reason})}},t);this.scheduledAutoSavesAfterDelay.set(e,Rt(()=>{this.logService.trace("[editor auto save] clearing pending auto save",e.resource.toString(),e.typeId),clearTimeout(i)}))}discardAutoSave(e){y(this.scheduledAutoSavesAfterDelay.get(e)),this.scheduledAutoSavesAfterDelay.delete(e),this.waitingOnConditionAutoSaveWorkingCopies.delete(e.resource),this.waitingOnConditionAutoSaveEditors.delete(e.resource)}},O.ID="workbench.contrib.editorAutoSave",O);B=p([u(0,ue),u(1,Oe),u(2,E),u(3,v),u(4,Ot),u(5,Mt),u(6,Gt),u(7,ae)],B);wt(B.ID,B,2);var re;let q=re=class extends _e{get typeId(){return ke}get editorId(){return _.id}get capabilities(){let e=32;return this.model?this.model.isReadonly()&&(e|=2):this.fileService.hasProvider(this.resource)?this.filesConfigurationService.isReadonly(this.resource)&&(e|=2):e|=4,e&2||(e|=128),e}constructor(e,t,i,r,s,o,n,d,a,h,l,M,A,ze,$e,He,Ye){super(e,t,ze,a,l,M,A,He,Ye),this.instantiationService=d,this.textModelService=h,this.pathService=$e,this.forceOpenAs=0,this.model=void 0,this.cachedTextFileModelReference=void 0,this.modelListeners=this._register(new P),this.model=this.textFileService.files.get(e),i&&this.setPreferredName(i),r&&this.setPreferredDescription(r),s&&this.setPreferredEncoding(s),o&&this.setPreferredLanguageId(o),typeof n=="string"&&this.setPreferredContents(n),this._register(this.textFileService.files.onDidCreate(je=>this.onDidCreateTextFileModel(je))),this.model&&this.registerModelListeners(this.model)}onDidCreateTextFileModel(e){b(e.resource,this.resource)&&(this.model=e,this.registerModelListeners(e))}registerModelListeners(e){this.modelListeners.clear(),this.modelListeners.add(e.onDidChangeDirty(()=>this._onDidChangeDirty.fire())),this.modelListeners.add(e.onDidChangeReadonly(()=>this._onDidChangeCapabilities.fire())),this.modelListeners.add(e.onDidSaveError(()=>this._onDidChangeDirty.fire())),this.modelListeners.add(z.once(e.onWillDispose)(()=>{this.modelListeners.clear(),this.model=void 0}))}getName(){return this.preferredName||super.getName()}setPreferredName(e){this.allowLabelOverride()&&this.preferredName!==e&&(this.preferredName=e,this._onDidChangeLabel.fire())}allowLabelOverride(){return this.resource.scheme!==this.pathService.defaultUriScheme&&this.resource.scheme!==x.vscodeUserData&&this.resource.scheme!==x.file&&this.resource.scheme!==x.vscodeRemote}getPreferredName(){return this.preferredName}isReadonly(){return this.model?this.model.isReadonly():this.filesConfigurationService.isReadonly(this.resource)}getDescription(e){return this.preferredDescription||super.getDescription(e)}setPreferredDescription(e){this.allowLabelOverride()&&this.preferredDescription!==e&&(this.preferredDescription=e,this._onDidChangeLabel.fire())}getPreferredDescription(){return this.preferredDescription}getTitle(e){let t=super.getTitle(e);const i=this.getPreferredTitle();return i&&(t=`${i} (${t})`),t}getPreferredTitle(){if(this.preferredName&&this.preferredDescription)return`${this.preferredName} ${this.preferredDescription}`;if(this.preferredName||this.preferredDescription)return this.preferredName??this.preferredDescription}getEncoding(){return this.model?this.model.getEncoding():this.preferredEncoding}getPreferredEncoding(){return this.preferredEncoding}async setEncoding(e,t){var i;return this.setPreferredEncoding(e),(i=this.model)==null?void 0:i.setEncoding(e,t)}setPreferredEncoding(e){this.preferredEncoding=e,this.setForceOpenAsText()}getLanguageId(){return this.model?this.model.getLanguageId():this.preferredLanguageId}getPreferredLanguageId(){return this.preferredLanguageId}setLanguageId(e,t){var i;this.setPreferredLanguageId(e),(i=this.model)==null||i.setLanguageId(e,t)}setPreferredLanguageId(e){this.preferredLanguageId=e,this.setForceOpenAsText()}setPreferredContents(e){this.preferredContents=e,this.setForceOpenAsText()}setForceOpenAsText(){this.forceOpenAs=1}setForceOpenAsBinary(){this.forceOpenAs=2}isDirty(){var e;return!!((e=this.model)!=null&&e.isDirty())}isSaving(){var e,t,i;return(e=this.model)!=null&&e.hasState(0)||(t=this.model)!=null&&t.hasState(3)||(i=this.model)!=null&&i.hasState(5)?!1:this.filesConfigurationService.hasShortAutoSaveDelay(this)?!0:super.isSaving()}prefersEditorPane(e){return this.forceOpenAs===2?e.find(t=>t.typeId===Tt):e.find(t=>t.typeId===_t)}resolve(e){return this.forceOpenAs===2?this.doResolveAsBinary():this.doResolveAsText(e)}async doResolveAsText(e){try{const t=this.preferredContents;this.preferredContents=void 0,await this.textFileService.files.resolve(this.resource,{languageId:this.preferredLanguageId,encoding:this.preferredEncoding,contents:typeof t=="string"?xt(t):void 0,reload:{async:!0},allowBinary:this.forceOpenAs===1,reason:1,limits:this.ensureLimits(e)}),this.cachedTextFileModelReference||(this.cachedTextFileModelReference=await this.textModelService.createModelReference(this.resource));const i=this.cachedTextFileModelReference.object;return this.isDisposed()&&this.disposeModelReference(),i}catch(t){if(t.textFileOperationResult===0)return this.doResolveAsBinary();throw t}}async doResolveAsBinary(){const e=this.instantiationService.createInstance(ie,this.preferredResource,this.getName());return await e.resolve(),e}isResolved(){return!!this.model}async rename(e,t){return{editor:{resource:t,encoding:this.getEncoding(),options:{viewState:Q(this,e,this.editorService)}}}}toUntyped(e){const t={resource:this.preferredResource,forceFile:!0,options:{override:this.editorId}};return typeof(e==null?void 0:e.preserveViewState)=="number"&&(t.encoding=this.getEncoding(),t.languageId=this.getLanguageId(),t.contents=(()=>{const i=this.textFileService.files.get(this.resource);if(i!=null&&i.isDirty()&&!i.textEditorModel.isTooLargeForHeapOperation())return i.textEditorModel.getValue()})(),t.options={...t.options,viewState:Q(this,e.preserveViewState,this.editorService)}),t}matches(e){return this===e?!0:e instanceof re?b(e.resource,this.resource):Te(e)?super.matches(e):!1}dispose(){this.model=void 0,this.disposeModelReference(),super.dispose()}disposeModelReference(){y(this.cachedTextFileModelReference),this.cachedTextFileModelReference=void 0}};q=re=p([u(7,H),u(8,ce),u(9,Pe),u(10,xe),u(11,L),u(12,ue),u(13,E),u(14,Fe),u(15,Le),u(16,Ue)],q);ne.as(de.EditorFactory).registerFileEditorFactory({typeId:ke,createFileEditor:(c,e,t,i,r,s,o,n)=>n.createInstance(q,c,e,t,i,r,s,o),isFileEditor:c=>c instanceof q});function qe(c){const e=c.get(We).lastFocusedList,t=e==null?void 0:e.getHTMLElement();if(t&&Ft(t)&&e instanceof Pt){const i=S(e.getSelectedElements().filter(n=>n instanceof me)),r=e.getFocusedElements(),s=r.length?r[0]:void 0;let o;return s instanceof me&&(o=s),i.some(n=>n===o)?i:o?[o]:void 0}}async function le(c,e){var n;const t=c.get(v),i=c.get(Kt),r=c.get(ce);let s=qe(c);if(!s){const d=t.activeGroup;d.activeEditor&&(s=[],d.activeEditor instanceof $&&!(e!=null&&e.saveAs)&&!(d.activeEditor.primary.hasCapability(4)||d.activeEditor.secondary.hasCapability(4))&&d.activeEditor.secondary.isModified()?(s.push({groupId:d.id,editor:d.activeEditor.primary}),s.push({groupId:d.id,editor:d.activeEditor.secondary})):s.push({groupId:d.id,editor:d.activeEditor}))}if(!s||s.length===0)return;await fe(c,s,e);const o=i.getFocusedCodeEditor();if(o instanceof zt&&!o.isSimpleWidget){const d=(n=o.getModel())==null?void 0:n.uri;if(d&&!s.some(({editor:a})=>b(W.getCanonicalUri(a,{supportSideBySide:R.PRIMARY}),d))){const a=r.files.get(d);a!=null&&a.isReadonly()||await r.save(d,e)}}}function Ke(c,e,t){const i=[];for(const r of e)for(const s of r.getEditors(0))s.isDirty()&&i.push({groupId:r.id,editor:s});return fe(c,i,t)}async function fe(c,e,t){const i=c.get(E),r=c.get(Ne),s=c.get(H);try{await i.save(e,t)}catch(o){if(!$t(o)){const n=[ye({id:"workbench.action.files.saveEditors",label:G(3745,"Retry"),run:()=>s.invokeFunction(a=>fe(a,e,t))})],d=e.filter(({editor:a})=>!a.hasCapability(4));d.length>0&&n.push(ye({id:"workbench.action.files.revertEditors",label:d.length>1?G(3746,"Revert All"):G(3747,"Revert"),run:()=>i.revert(d)})),r.notify({id:e.map(({editor:a})=>{var h;return Ht((h=a.resource)==null?void 0:h.toString())}).join(),severity:Yt.Error,message:G(3748,"Failed to save '{0}': {1}",e.map(({editor:a})=>a.getName()).join(", "),Ve(o,!1)),actions:{primary:n}})}}}Y.registerCommandAndKeybindingRule({when:void 0,weight:200,primary:2097,id:Lt,handler:c=>le(c,{reason:1,force:!0})});Y.registerCommandAndKeybindingRule({when:void 0,weight:200,primary:Z(2089,49),win:{primary:Z(2089,3121)},id:Ut,handler:c=>le(c,{reason:1,force:!0,skipSaveParticipants:!0})});Y.registerCommandAndKeybindingRule({id:kt,weight:200,when:void 0,primary:3121,handler:c=>le(c,{reason:1,saveAs:!0})});Y.registerCommandAndKeybindingRule({when:void 0,weight:200,primary:void 0,mac:{primary:2609},win:{primary:Z(2089,49)},id:Wt,handler:c=>Ke(c,c.get(v).getGroups(1),{reason:1})});he.registerCommand({id:Nt,handler:(c,e,t)=>{const i=c.get(v),r=Vt([t],c.get(E),i,c.get(We));let s;return r.groupedEditors.length?s=r.groupedEditors.map(({group:o})=>o):s=i.getGroups(1),Ke(c,s,{reason:1})}});he.registerCommand({id:Bt,handler:async c=>(await c.get(E).saveAll({includeUntitled:!1,reason:1})).success});he.registerCommand({id:qt,handler:async c=>{const e=c.get(v),t=c.get(E);let i=qe(c);if(!i){const r=e.activeGroup;r.activeEditor&&(i=[{groupId:r.id,editor:r.activeEditor}])}if(!(!i||i.length===0))try{await t.revert(i.filter(({editor:r})=>!r.hasCapability(4)),{force:!0})}catch(r){c.get(Ne).error(G(3749,"Failed to revert '{0}': {1}",i.map(({editor:o})=>o.getName()).join(", "),Ve(r,!1)))}}});export{ie as B,Ie as C,be as E,q as F,Ae as T,V as U,Ce as f};
